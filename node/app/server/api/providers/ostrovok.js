// Generated by LiveScript 1.2.0
(function(){
  var _, async, cache, database, request, winston, getOstrovokId, query, process, autocomplete;
  _ = require("underscore");
  async = require("async");
  cache = require("./../../cache");
  database = require("./../../database");
  request = require("request");
  winston = require("winston");
  exports.name = "ostrovok.ru";
  getOstrovokId = function(place, callback){
    if (place.ostrovok_id) {
      return callback(null, place.ostrovok_id);
    }
    return autocomplete(place.name_ru + ", " + place.country_name_ru, function(error, result){
      var processResult;
      if (error) {
        return callback(error, null);
      }
      processResult = function(result){
        var ostrovok_id;
        ostrovok_id = result[0].oid;
        callback(null, ostrovok_id);
        return database.geonames.update({
          geoname_id: place.geoname_id
        }, {
          $set: {
            ostrovok_id: ostrovok_id
          }
        }, function(error, place){});
      };
      if (result.length === 0) {
        return autocomplete(place.name_ru + "", function(error, result){
          if (error || result.length === 0) {
            return callback({
              message: 'nothing found'
            }, null);
          }
          return processResult(result);
        });
      } else {
        return processResult(result);
      }
    });
  };
  query = function(origin, destination, extra, cb){
    return async.parallel({
      origin: function(callback){
        return getOstrovokId(origin.place, callback);
      },
      destination: function(callback){
        return getOstrovokId(destination.place, callback);
      }
    }, function(error, ostrovokId){
      var ostUrl;
      if (error) {
        return cb(error, null);
      }
      ostUrl = "http://ostrovok.ru/api/v1/search/page/" + extra.page + "/?region_id=" + ostrovokId.destination + "&arrivalDate=" + origin.date + "&departureDate=" + destination.date + "&room1_numberOfAdults=" + extra.adults;
      return cache.request(ostUrl, function(error, body){
        var json, page;
        if (error) {
          return cb(error, null);
        }
        json = JSON.parse(body);
        page = json._next_page;
        cb(null, json);
        if (page) {
          extra.page = page;
          return query(origin, destination, extra, cb);
        }
      });
    });
  };
  process = function(json, cb){
    var hotels, rates, ref$, hotelsWithRooms, operations;
    if (!json || json.hotels == null) {
      return cb('empty json', null);
    }
    hotels = json.hotels;
    rates = (ref$ = json._meta) != null ? ref$.rates : void 8;
    if (!rates) {
      return cb({
        message: 'no rates'
      }, null);
    }
    hotelsWithRooms = _.filter(hotels, function(hotel){
      return hotel.rooms;
    });
    operations = _.map(hotelsWithRooms, function(hotel){
      return function(callback){
        var rating, ref$, count, price, stars, newHotel;
        rating = 0;
        if (((ref$ = hotel.rating) != null ? ref$.total : void 8) != null) {
          count = hotel.rating.count;
          if (count > 25) {
            rating = hotel.rating.total * count;
          }
        }
        price = hotel.rooms[0].total_rate * rates[hotel.rooms[0].currency];
        stars = 1;
        if (hotel.star_rating) {
          stars = hotel.star_rating / 10.0;
        }
        newHotel = {
          id: hotel.ostrovok_id,
          name: hotel.name,
          photo: hotel.thumbnail_url_220,
          price: price,
          provider: exports.name,
          rating: rating,
          stars: stars,
          type: 'hotel',
          url: "http://ostrovok.ru" + hotel.url + "&partner_slug=ostroterra",
          latitude: hotel.latitude,
          longitude: hotel.longitude,
          description: hotel.description_short,
          address: hotel.address,
          images: [hotel.thumbnail_url_220, hotel.thumbnail_url_220, hotel.thumbnail_url_220, hotel.thumbnail_url_220]
        };
        callback(null, newHotel);
        return database.hotels.insert(newHotel);
      };
    });
    return async.series(operations, function(error, hotels){
      return cb(null, {
        results: hotels,
        complete: !json._next_page
      });
    });
  };
  exports.search = function(origin, destination, extra, cb){
    return query(origin, destination, extra, function(error, hotelResult){
      if (error) {
        return cb(error, null);
      }
      return process(hotelResult, function(error, hotels){
        if (error) {
          return cb(error, null);
        }
        return cb(null, hotels);
      });
    });
  };
  exports.details = function(id, callback){
    return database.hotels.findOne({
      provider: exports.name,
      id: id
    }, function(error, hotel){
      if (error || !hotel) {
        return callback(error, null);
      }
      return callback(null, hotel);
    });
  };
  autocomplete = function(query, callback){
    var ostUrl;
    ostUrl = "http://ostrovok.ru/api/site/multicomplete.json?query=" + query + "&regions_ver=v5";
    return cache.request(ostUrl, function(error, body){
      var json, finalJson, i$, ref$, len$, obj, country, name, id, displayName;
      if (error) {
        return callback(error, null);
      }
      json = JSON.parse(body);
      finalJson = [];
      for (i$ = 0, len$ = (ref$ = json.regions).length; i$ < len$; ++i$) {
        obj = ref$[i$];
        if (obj.target === "search" && obj.type === 'city') {
          country = obj.country;
          name = obj.name;
          if (name === 'Нью-Дели') {
            name = 'Дели';
          }
          id = obj.id;
          displayName = name;
          if (name.split(',').length > 1) {
            name = name.split(',')[0];
          }
          if (country !== "Россия") {
            displayName += ", " + country;
          }
          finalJson.push({
            name: name,
            oid: id,
            country: country,
            displayName: displayName,
            provider: exports.name
          });
        }
      }
      return callback(null, finalJson);
    });
  };
}).call(this);
